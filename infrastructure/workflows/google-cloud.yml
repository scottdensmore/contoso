name: Deploy to Google Cloud Run

on:
  push:
    branches:
      - main
      - feat/google-cloud-deployment
  workflow_dispatch:

env:
  PROJECT_ID: contoso-outdoor
  REGION: us-central1
  ENVIRONMENT: dev

jobs:
  infrastructure:
    runs-on: ubuntu-latest
    outputs:
      db_instance_name: ${{ steps.tf-output.outputs.db_instance_name }}
      db_name: ${{ steps.tf-output.outputs.db_name }}
      db_user: ${{ steps.tf-output.outputs.db_user }}
      container_registry_url: ${{ steps.tf-output.outputs.container_registry_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        run: terraform init
        working-directory: ./infrastructure/terraform

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve \
            -var="project_id=${{ env.PROJECT_ID }}" \
            -var="environment_name=${{ env.ENVIRONMENT }}" \
            -var="region=${{ env.REGION }}"
        working-directory: ./infrastructure/terraform

      - name: Get Terraform Outputs
        id: tf-output
        run: |
          echo "db_instance_name=$(terraform output -raw db_instance_name)" >> $GITHUB_OUTPUT
          echo "db_name=$(terraform output -raw db_name)" >> $GITHUB_OUTPUT
          echo "db_user=$(terraform output -raw db_user)" >> $GITHUB_OUTPUT
          echo "container_registry_url=$(terraform output -raw container_registry_url)" >> $GITHUB_OUTPUT
        working-directory: ./infrastructure/terraform

  deploy-web:
    needs: infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Docker Login
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Web Image
        run: |
          IMAGE_PATH="${{ needs.infrastructure.outputs.container_registry_url }}/contoso-web:${GITHUB_SHA}"
          docker build -t ${IMAGE_PATH} .
          docker push ${IMAGE_PATH}
          echo "image_path=${IMAGE_PATH}" >> $GITHUB_ENV

      - name: Deploy Web to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: contoso-web
          region: ${{ env.REGION }}
          image: ${{ env.image_path }}
          env_vars: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}

  deploy-chat:
    needs: infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Docker Login
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Chat Image
        run: |
          IMAGE_PATH="${{ needs.infrastructure.outputs.container_registry_url }}/contoso-chat:${GITHUB_SHA}"
          cd services/chat
          docker build -t ${IMAGE_PATH} .
          docker push ${IMAGE_PATH}
          echo "image_path=${IMAGE_PATH}" >> $GITHUB_ENV

      - name: Deploy Chat to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: contoso-chat
          region: ${{ env.REGION }}
          image: ${{ env.image_path }}
          env_vars: |
            PROJECT_ID=${{ env.PROJECT_ID }}
            REGION=${{ env.REGION }}
            ENVIRONMENT=${{ env.ENVIRONMENT }}
