name: Continuous Integration

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  changes:
    name: Detect Changed Surfaces
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.detector.outputs.web }}
      chat: ${{ steps.detector.outputs.chat }}
      runtime: ${{ steps.detector.outputs.runtime }}
      docs: ${{ steps.detector.outputs.docs }}
      unknown: ${{ steps.detector.outputs.unknown }}
      none: ${{ steps.detector.outputs.none }}
      targets: ${{ steps.detector.outputs.targets }}
      base: ${{ steps.detector.outputs.base }}
      head: ${{ steps.detector.outputs.head }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Detect scoped changes
        id: detector
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "base=" >> "$GITHUB_OUTPUT"
            echo "head=${{ github.sha }}" >> "$GITHUB_OUTPUT"
            echo "runtime=true" >> "$GITHUB_OUTPUT"
            echo "web=true" >> "$GITHUB_OUTPUT"
            echo "chat=true" >> "$GITHUB_OUTPUT"
            echo "docs=true" >> "$GITHUB_OUTPUT"
            echo "unknown=false" >> "$GITHUB_OUTPUT"
            echo "none=false" >> "$GITHUB_OUTPUT"
            echo "targets=toolchain-doctor env-contract-check test-scripts quick-ci-web quick-ci-chat docs-check" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi
          HEAD_SHA="${{ github.sha }}"

          echo "base=$BASE_SHA" >> "$GITHUB_OUTPUT"
          echo "head=$HEAD_SHA" >> "$GITHUB_OUTPUT"

          if [[ -z "$BASE_SHA" || "$BASE_SHA" == "0000000000000000000000000000000000000000" ]]; then
            echo "runtime=true" >> "$GITHUB_OUTPUT"
            echo "web=true" >> "$GITHUB_OUTPUT"
            echo "chat=true" >> "$GITHUB_OUTPUT"
            echo "docs=true" >> "$GITHUB_OUTPUT"
            echo "unknown=false" >> "$GITHUB_OUTPUT"
            echo "none=false" >> "$GITHUB_OUTPUT"
            echo "targets=toolchain-doctor env-contract-check test-scripts quick-ci-web quick-ci-chat docs-check" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          python scripts/detect_changed_surfaces.py \
            --base "$BASE_SHA" \
            --head "$HEAD_SHA" \
            --github-output "$GITHUB_OUTPUT"

  env-contract:
    name: Env Contract Drift Check
    needs: changes
    if: ${{ github.event_name != 'push' && needs.changes.outputs.runtime == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate env contract
        run: make env-contract-check PYTHON=python

  script-tests:
    name: Script Guardrail Tests
    needs: changes
    if: ${{ github.event_name != 'push' && needs.changes.outputs.runtime == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run script tests
        run: make test-scripts PYTHON=python

  docs-ci:
    name: Documentation Link Checks
    needs: changes
    if: ${{ github.event_name != 'push' && (needs.changes.outputs.docs == 'true' || needs.changes.outputs.runtime == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Verify docs links
        run: make docs-check PYTHON=python

  web-ci:
    name: Web App CI
    needs: changes
    if: ${{ github.event_name != 'push' && (needs.changes.outputs.web == 'true' || needs.changes.outputs.runtime == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Toolchain preflight
        run: TOOLCHAIN_CHECK_ALLOW_NON_MISE=1 make toolchain-doctor PYTHON=python

      - name: Install dependencies
        env:
          HUSKY: 0
        run: make -C apps/web setup

      - name: Run web checks
        run: npm run ci:web

  chat-ci:
    name: Chat Service CI
    needs: changes
    if: ${{ github.event_name != 'push' && (needs.changes.outputs.chat == 'true' || needs.changes.outputs.runtime == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Toolchain preflight
        run: TOOLCHAIN_CHECK_ALLOW_NON_MISE=1 make toolchain-doctor PYTHON=python

      - name: Install dependencies
        run: make -C services/chat setup

      - name: Generate Prisma Client (Python)
        run: |
          prisma-client-py generate --schema=${{ github.workspace }}/apps/web/prisma/schema.prisma

      - name: Run unit tests
        run: npm run ci:chat
        env:
          PROJECT_ID: local-project
          REGION: us-central1

  integration-e2e:
    name: Integration E2E Smoke
    needs: changes
    if: ${{ github.event_name != 'push' && (needs.changes.outputs.web == 'true' || needs.changes.outputs.chat == 'true' || needs.changes.outputs.runtime == 'true') }}
    runs-on: ubuntu-latest
    timeout-minutes: 35
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build web image (cached)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          load: true
          tags: contoso-web:latest
          cache-from: type=gha,scope=contoso-web
          cache-to: type=gha,mode=max,scope=contoso-web

      - name: Build chat image (cached, minimal profile)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/chat/Dockerfile
          load: true
          tags: contoso-chat:latest
          build-args: |
            INSTALL_LOCAL_STACK=0
          cache-from: type=gha,scope=contoso-chat
          cache-to: type=gha,mode=max,scope=contoso-chat

      - name: Run e2e smoke
        id: run_smoke
        env:
          KEEP_STACK: '1'
          DOCKER_BUILDKIT: '1'
          COMPOSE_DOCKER_CLI_BUILD: '1'
          E2E_SMOKE_TIMEOUT: '300'
        run: |
          start_epoch="$(date +%s)"
          make e2e-smoke-lite \
            PYTHON=python \
            KEEP_STACK=1 \
            E2E_SMOKE_TIMEOUT="${E2E_SMOKE_TIMEOUT}" \
            CHAT_INSTALL_LOCAL_STACK=0 \
            E2E_COMPOSE_UP_FLAGS="-d --force-recreate --quiet-pull"
          end_epoch="$(date +%s)"
          echo "duration_seconds=$((end_epoch-start_epoch))" >> "$GITHUB_OUTPUT"

      - name: Capture compose logs
        if: always()
        run: |
          docker compose ps || true
          docker compose logs --no-color db chat web > e2e-compose.log || true

      - name: Capture e2e metrics
        if: always()
        run: |
          duration="${{ steps.run_smoke.outputs.duration_seconds }}"
          [ -z "$duration" ] && duration="unknown"
          chat_size="$(docker image inspect contoso-chat:latest --format '{{.Size}}' 2>/dev/null || echo 0)"
          web_size="$(docker image inspect contoso-web:latest --format '{{.Size}}' 2>/dev/null || echo 0)"
          max_duration=420
          max_chat_size=2500000000
          max_web_size=1500000000
          {
            echo "duration_seconds=$duration"
            echo "chat_image_bytes=$chat_size"
            echo "web_image_bytes=$web_size"
            if [ "$duration" != "unknown" ] && [ "$duration" -gt "$max_duration" ]; then
              echo "warning=duration_above_budget"
            fi
            if [ "$chat_size" -gt "$max_chat_size" ]; then
              echo "warning=chat_image_above_budget"
            fi
            if [ "$web_size" -gt "$max_web_size" ]; then
              echo "warning=web_image_above_budget"
            fi
          } | tee e2e-metrics.txt

      - name: Upload e2e logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-compose-logs-${{ github.run_id }}
          path: |
            e2e-compose.log
            e2e-metrics.txt
          if-no-files-found: warn

      - name: Teardown e2e stack
        if: always()
        run: docker compose down --volumes --remove-orphans

  onboarding-smoke:
    name: Onboarding Smoke
    needs: changes
    if: ${{ github.event_name != 'push' && needs.changes.outputs.runtime == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Bootstrap and doctor
        env:
          TOOLCHAIN_CHECK_ALLOW_NON_MISE: '1'
          HUSKY: '0'
        run: make bootstrap PYTHON=python

  full-ci-main:
    name: Full CI (Main Branch)
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Toolchain preflight
        run: TOOLCHAIN_CHECK_ALLOW_NON_MISE=1 make toolchain-doctor PYTHON=python

      - name: Install web dependencies
        env:
          HUSKY: '0'
        run: make -C apps/web setup

      - name: Install chat dependencies
        run: make -C services/chat setup

      - name: Generate Prisma Client (Python)
        run: prisma-client-py generate --schema=${{ github.workspace }}/apps/web/prisma/schema.prisma

      - name: Run full CI checks
        env:
          TOOLCHAIN_CHECK_ALLOW_NON_MISE: '1'
          HUSKY: '0'
          PROJECT_ID: local-project
          REGION: us-central1
        run: make ci PYTHON=python
